{% extends "layout.html" %}

{% from "fieldset/macro.njk" import govukFieldset %}
{% from "button/macro.njk" import govukButton %}
{% from "input/macro.njk" import govukInput %}
{% from "error-summary/macro.njk" import govukErrorSummary %}
{% from "select/macro.njk" import govukSelect %}
{% from "navigation.njk" import navigationHeaderBlock %}

{% block header %}
    {% if fmt %}
        {{ navigationHeaderBlock('/summary') }}
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% set riverItems = [] %}

{% if not payload or not payload.river %}
    {{ riverItems.push(null) }}
{% endif %}

{% for river in rivers %}
    {{ riverItems.push({
        text: river.name,
        value: river.id,
        selected: river.id.toString() === payload.river
    }) }}
{% endfor %}

{% set monthItems = [] %}

{% if not payload or not payload.month %}
    {{ monthItems.push(null) }}
{% endif %}

{% for month in months %}
    {{ monthItems.push({
        text: month.text,
        value: month.value,
        selected: month.value === payload.month
    }) }}
{% endfor %}

{% set errorList = [] %}
{% set riverErrorMessage = null %}
{% set releasedErrorMessage = null %}
{% set monthsErrorMessage = null %}
{% set flyErrorMessage = null %}
{% set spinnerErrorMessage = null %}
{% set baitErrorMessage = null %}
{% set unknownErrorMessage = null %}

{% if errors %}
    {% for error in errors %}
        {% if error.river %}
            {% set riverErrorMessage = { text: "Select a river" } %}
            {{ errorList.push({
                text: "You have not selected a river",
                href: "#river"
            }) }}
        {% endif %}

        {% if error.months %}
            {% set monthsErrorMessage = { text: "Select the month you caught the fish" } %}
            {{ errorList.push({
                text: "You have not selected a month",
                href: "#month"
            }) }}
        {% endif %}

        {% if error.released %}
            {% set releasedErrorMessage = { text: "Enter the number of fish released back into the water" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish released back into the water",
                href: "#released"
            }) }}
        {% endif %}

         {% if error.fly %}
            {% set flyErrorMessage = { text: "Enter the number of fish caught using a fly" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish caught using a fly",
                href: "#fly"
            }) }}
        {% endif %}

        {% if error.spinner %}
            {% set spinnerErrorMessage = { text: "Enter the number of small fish caught using a spinner" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish caught using a spinner",
                href: "#spinner"
            }) }}
        {% endif %}

        {% if error.bait %}
            {% set baitErrorMessage = { text: "Enter the number of fish caught using bait" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish caught using bait",
                href: "#bait"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_RELEASED_EXCEEDS_COUNTS' %}
            {% set releasedErrorMessage = { text: "The number of fish released cannot exceed the number of fish caught" } %}
            {{ errorList.push({
                text: "You have released more fish than you have caught",
                href: "#released"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_DUPLICATE_FOUND' %}
            {% set riverErrorMessage = { text: "Select a river" } %}
            {% set monthsErrorMessage = { text: "Select the month your caught the fish" } %}
            {{ errorList.push({
                text: "You have already added a record for this river and this month - choose a different river or month",
                href: "#river"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_COUNTS_REQUIRED' %}
            {{ errorList.push({
                text: "You have not entered the number of fish caught",
                href: "#river"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_RELEASED_NEGATIVE' %}
            {% set releasedErrorMessage = { text: "The number released must be 0 or above" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish released",
                href: "#released"
            }) }}
        {% endif %}

        {% if error.Fly === 'SMALL_CATCH_COUNTS_NOT_GREATER_THAN_ZERO' %}
            {% set flyErrorMessage = { text: "The number caught with a fly must be greater than zero" } %}
            {{ errorList.push({
                text: "Enter the number caught with a fly",
                href: "#fly"
            }) }}
        {% endif %}

        {% if error.Spinner === 'SMALL_CATCH_COUNTS_NOT_GREATER_THAN_ZERO' %}
            {% set spinnerErrorMessage = { text: "The number caught with a spinner must be greater than zero" } %}
            {{ errorList.push({
                text: "Enter the number caught with a spinner",
                href: "#spinner"
            }) }}
        {% endif %}

        {% if error.Bait === 'SMALL_CATCH_COUNTS_NOT_GREATER_THAN_ZERO' %}
            {% set baitErrorMessage = { text: "The number caught with bait must be greater than zero" } %}
            {{ errorList.push({
                text: "Enter the number caught with bait",
                href: "#bait"
            }) }}
        {% endif %}

        {% if error.Unknown === 'SMALL_CATCH_COUNTS_NOT_GREATER_THAN_ZERO' %}
            {% set unknownErrorMessage = { text: "The number caught with an unknown must be greater than zero" } %}
            {{ errorList.push({
                text: "Enter the number caught by an unknown method",
                href: "#unknown"
            }) }}
    {% endif %}

    {% endfor %}
{% endif %}

{% block pageTitle %}{% if add %}Add{% else %}Edit{% endif %} a small adult sea trout catch {{ suffix }} - GOV.UK{% endblock %}

{% if rivers.length === 1 %}
    {% set suffix = "caught on river " + rivers[0].name %}
{% endif %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <form method="post">

            {% if errors %}
                {{ govukErrorSummary({
                    titleText: "There is a problem",
                    errorList: errorList
                }) }}
            {% endif %}

            {% if add %}
                <h1 class="govuk-heading-l">Add a small adult sea trout catch {{ suffix }}</h1><p class="govuk-body-l">Add details of small adult sea trout (1lb and under) catches by month</p>
            {% else %}
                <h1 class="govuk-heading-l">Edit a small adult sea trout catch {{ suffix }}</h1>
            {% endif %}

            {% call govukFieldset({}) %}

                {% if rivers.length > 1 %}
                    {{ govukSelect({
                        id: "river",
                        name: "river",
                        label: {
                            text: "River"
                        },
                        fieldset: {
                            legend: {
                                text: "River",
                                isPageHeading: false,
                                classes: "govuk-fieldset__legend govuk-!-font-weight-bold"
                            }
                        },
                        items: riverItems,
                        errorMessage: riverErrorMessage
                    }) }}
                {% else %}
                    <input type="hidden" id="river" name="river" value="{{ rivers[0].id }}"/>
                {% endif %}

                {{ govukSelect({
                    id: "month",
                    name: "month",
                    label: {
                        text: "Select month"
                    },
                    fieldset: {
                        legend: {
                            text: "Month the fish were caught",
                            isPageHeading: false,
                            classes: "govuk-fieldset__legend govuk-!-font-weight-bold"
                        }
                    },
                    items: monthItems,
                    errorMessage: monthsErrorMessage
                }) }}

                {% if errors %}{% for error in errors %}{% if error.SmallCatch === 'SMALL_CATCH_COUNTS_REQUIRED' %}
                <div class="govuk-form-group govuk-form-group--error">
                    <span id="fly-error" class="govuk-error-message">
                        Total number caught must be greater than 0
                    </span>
                {% endif %}{% endfor %}{% endif %}

                {{ govukInput({
                    id: "fly",
                    name: "fly",
                    hint: { text: "Number of fish caught with a fly" },
                    label: {
                        text: "Fly"
                    },
                    value: payload.fly,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: flyErrorMessage
                }) }}

                {{ govukInput({
                    id: "spinner",
                    name: "spinner",
                    hint: { text: "Number of fish caught with a spinner" },
                    label: {
                        text: "Spinner"
                    },
                    value: payload.spinner,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: spinnerErrorMessage
                }) }}

                {{ govukInput({
                    id: "bait",
                    name: "bait",
                    hint: { text: "Number of fish caught with bait" },
                    label: {
                        text: "Bait"
                    },
                    value: payload.bait,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: baitErrorMessage
                }) }}

                {% if fmt %}
                    {{ govukInput({
                        id: "unknown",
                        name: "unknown",
                        hint: { text: "Number of fish caught using an unknown method" },
                        label: {
                            text: "Unknown"
                        },
                        value: payload.unknown,
                        attributes: { maxlength: 4 },
                        classes: "govuk-input--width-4",
                        errorMessage: unknownErrorMessage
                    }) }}
                {% endif %}

                {% if errors %}{% for error in errors %}{% if error.SmallCatch === 'SMALL_CATCH_COUNTS_REQUIRED' %}
                </div>
                {% endif %}{% endfor %}{% endif %}

                {{ govukInput({
                    id: "released",
                    name: "released",
                    hint: { text: "Number of fish released back into the water" },
                    label: {
                        text: "Released"
                    },
                    value: payload.released,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: releasedErrorMessage
                }) }}

                {{ govukButton({
                    name: "continue",
                    text: "Save",
                    attributes: { onclick: "var e=this;setTimeout(function(){e.disabled=true;},0);return true;" }
                }) }}

                {% if add %}
                    {{ govukButton({
                        name: "add",
                        text: "Save and add another",
                        classes: "govuk-button-secondary",
                        attributes: { onclick: "var e=this;setTimeout(function(){e.disabled=true;},0);return true;" }
                    }) }}
                {% endif %}
            {% endcall %}
            {{ extra() }}
        </form>
        {{ summaryLink() }}
    </div>
</div>

{% endblock %}
