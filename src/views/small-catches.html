{% extends "layout.html" %}

{% from "back-link/macro.njk" import govukBackLink %}
{% from "fieldset/macro.njk" import govukFieldset %}
{% from "button/macro.njk" import govukButton %}
{% from "input/macro.njk" import govukInput %}
{% from "error-summary/macro.njk" import govukErrorSummary %}
{% from "select/macro.njk" import govukSelect %}

{% set riverItems = [] %}

{% if not payload or not payload.river %}
    {{ riverItems.push(null) }}
{% endif %}

{% for river in rivers %}
    {{ riverItems.push({
        text: river.name,
        value: river.id,
        selected: river.id.toString() === payload.river
    }) }}
{% endfor %}

{% set monthItems = [] %}

{% if not payload or not payload.month %}
    {{ monthItems.push(null) }}
{% endif %}

{% for month in months %}
    {{ monthItems.push({
        text: month.text,
        value: month.value,
        selected: month.value === payload.month
    }) }}
{% endfor %}

{% set errorList = [] %}
{% set riverErrorMessage = null %}
{% set releasedErrorMessage = null %}
{% set monthsErrorMessage = null %}
{% set flyErrorMessage = null %}
{% set spinnerErrorMessage = null %}
{% set baitErrorMessage = null %}

{% if errors %}
    {% for error in errors %}
        {% if error.river %}
            {% set riverErrorMessage = { text: "Select a river" } %}
            {{ errorList.push({
                text: "You have not selected a river",
                href: "#river-1"
            }) }}
        {% endif %}

        {% if error.months %}
            {% set monthsErrorMessage = { text: "Select the month you caught the fish" } %}
            {{ errorList.push({
                text: "You have not selected a month",
                href: "#month-1"
            }) }}
        {% endif %}

        {% if error.released %}
            {% set releasedErrorMessage = { text: "Enter the number of fish released back into the water" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish released back into the water",
                href: "#released"
            }) }}
        {% endif %}

        <!--Shame you cannot do arbitrary object assignment out of the box in nunjunks-->
        {% if error.fly %}
            {% set flyErrorMessage = { text: "Enter the number of fish caught using a fly" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish caught using a fly",
                href: "#fly"
            }) }}
        {% endif %}

        {% if error.spinner %}
            {% set spinnerErrorMessage = { text: "Enter the number of small fish caught using a spinner" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish caught using a spinner",
                href: "#spinner"
            }) }}
        {% endif %}

        {% if error.bait %}
            {% set baitErrorMessage = { text: "Enter the number of fish caught using bait" } %}
            {{ errorList.push({
                text: "You have not entered a valid number of fish caught using bait",
                href: "#bait"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_RELEASED_EXCEEDS_COUNTS' %}
            {% set releasedErrorMessage = { text: "The number of fish released cannot exceed the number of fish caught" } %}
            {{ errorList.push({
                text: "You have released more fish than you have caught",
                href: "#fly"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_DUPLICATE_FOUND' %}
            {% set riverErrorMessage = { text: "Select a river" } %}
            {% set monthsErrorMessage = { text: "Select the month your caught the fish" } %}
            {{ errorList.push({
                text: "You have already added a record for this river and this month - choose a different river or month",
                href: "#river"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_COUNTS_REQUIRED' %}
            {% set spinnerErrorMessage = { text: "The number caught with a spinner, bait or fly must be greater than zero" } %}
            {% set baitErrorMessage = { text: "The number caught with a spinner, bait or fly must be greater than zero" } %}
            {% set flyErrorMessage = { text: "The number caught with a spinner, bait or fly must be greater than zero" } %}
            {{ errorList.push({
                text: "You must enter the number of fish caught by spinner, bait or fly",
                href: "#river"
            }) }}
        {% endif %}

        {% if error.SmallCatch === 'SMALL_CATCH_COUNTS_NOT_GREATER_THAN_ZERO' %}
            {% if error.property === 'counts[0]' %}
                {% set flyErrorMessage = { text: "The number caught with a fly must be greater than zero" } %}
                {{ errorList.push({
                    text: "Enter the number caught with a fly",
                    href: "#fly"
                }) }}
            {% endif %}


            {% if error.property === 'counts[1]' %}
                {% set spinnerErrorMessage = { text: "The number caught with a spinner must be greater than zero" } %}
                {{ errorList.push({
                    text: "Enter the number caught with a spinner",
                    href: "#spinner"
                }) }}
            {% endif %}

            {% if error.property === 'counts[2]' %}
                {% set baitErrorMessage = { text: "The number caught with bait must be greater than zero" } %}
                {{ errorList.push({
                    text: "Enter the number caught with bait",
                    href: "#bait"
                }) }}
            {% endif %}
        {% endif %}

    {% endfor %}
{% endif %}

{% block beforeContent %}
    {{ super() }}
    {{ govukBackLink({
        href: "/summary",
        text: "Back"
    }) }}
{% endblock %}

{% block pageTitle %}{% if add %}Add{% else %}Edit{% endif %} small adult sea trout catch{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <form method="post">
            {% if errors %}
                {{ govukErrorSummary({
                    titleText: "There is a problem",
                    errorList: errorList
                }) }}
            {% endif %}

            {% if add %}
                <h1 class="govuk-heading-l">Add a small adult sea trout catch</h1><p class="govuk-body-l">Add details of small adult sea trout (1lb and under) catches by month</p>
            {% else %}
                <h1 class="govuk-heading-l">Edit a small adult sea trout catch</h1>
            {% endif %}

            {% call govukFieldset({}) %}

                {% if rivers.length > 1 %}
                    {{ govukSelect({
                        id: "river",
                        name: "river",
                        label: {
                            text: "River"
                        },
                        fieldset: {
                            legend: {
                                text: "River",
                                isPageHeading: false,
                                classes: "govuk-fieldset__legend govuk-!-font-weight-bold"
                            }
                        },
                        items: riverItems,
                        errorMessage: riverErrorMessage
                    }) }}
                {% else %}
                    <h2 class="govuk-heading-m">River {{ rivers[0].name }}</h2>
                    <input type="hidden" id="river" name="river" value="{{ rivers[0].id }}"/>
                {% endif %}

                {{ govukSelect({
                    id: "month",
                    name: "month",
                    label: {
                        text: "Month"
                    },
                    hint: { text: "Select month" },
                    fieldset: {
                        legend: {
                            text: "Month the fish were caught",
                            isPageHeading: false,
                            classes: "govuk-fieldset__legend govuk-!-font-weight-bold"
                        }
                    },
                    items: monthItems,
                    errorMessage: monthsErrorMessage
                }) }}

                {{ govukInput({
                    id: "fly",
                    name: "fly",
                    hint: { text: "Enter the number of fish caught using a fly" },
                    label: {
                        text: "Fly"
                    },
                    value: payload.fly,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: flyErrorMessage
                }) }}

                {{ govukInput({
                    id: "spinner",
                    name: "spinner",
                    hint: { text: "Enter the number of fish caught using a spinner" },
                    label: {
                        text: "Spinner"
                    },
                    value: payload.spinner,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: spinnerErrorMessage
                }) }}

                {{ govukInput({
                    id: "bait",
                    name: "bait",
                    hint: { text: "Enter the number of fish caught using bait" },
                    label: {
                        text: "Bait"
                    },
                    value: payload.bait,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: baitErrorMessage
                }) }}

                {{ govukInput({
                    id: "released",
                    name: "released",
                    hint: { text: "Enter the number of fish released back into the water" },
                    label: {
                        text: "Number released"
                    },
                    value: payload.released,
                    attributes: { maxlength: 4 },
                    classes: "govuk-input--width-4",
                    errorMessage: releasedErrorMessage
                }) }}

                {{ govukButton({
                    name: "continue",
                    text: "Save"
                }) }}

                {% if add %}
                    {{ govukButton({
                        name: "add",
                        text: "Save and add another",
                        classes: "govuk-button-secondary"
                    }) }}
                {% endif %}
            {% endcall %}
            {{ extra() }}
        </form>
        {{ summaryLink() }}
    </div>
</div>

{% endblock %}
