{% extends "layout.html" %}

{% from "button/macro.njk" import govukButton %}
{% from "table/macro.njk" import govukTable %}
{% from "fieldset/macro.njk" import govukFieldset %}
{% from "checkboxes/macro.njk" import govukCheckboxes %}
{% from "navigation.njk" import navigationHeaderBlock %}

{% block header %}
    {% if fmt %}
        {{ navigationHeaderBlock('/summary') }}
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% block pageTitle %}Your {{ year }} catch return{% endblock %}

{% set riverRows = [] %}
{% set salmonAndLargeTroutItems = [] %}
{% set smallCatchItems = [] %}

{% macro riverLinks(id) %}
    {% set deleteurl = "/delete/" + id %}
    <a id="delete-river-{{ id }}" class="govuk-link" href="{{ deleteurl }}">Delete</a>
{% endmacro %}

{% macro renderLinks(id) %}
    {% set editurl = id %}
    {% set deleteurl = "/delete/" + id %}
    <span><a id="edit-{{ id }}" class="govuk-link" href="{{ editurl }}">Change</a>&nbsp;&#x7c;&nbsp;<a id="delete-{{ id }}" class="govuk-link" href="{{ deleteurl }}">Delete</a></span>
{% endmacro %}

{% macro renderCheck(id, name, checked) %}
<div class="govuk-checkboxes__item">
    <input class="govuk-checkboxes__input" type="checkbox" id="exclude-{{ id }}" name="{{ name }}" value="{{ id }}" {% if checked %}checked="checked"{% endif %}>
    <label for="exclude-{{ id }}" class="rcr-checkboxes__label"></label>
</div>
{% endmacro %}

{% if activities.length %}
    {% for activity in activities %}
        {{ riverRows.push([
            { text: activity.river.name },
            { text: activity.daysFishedWithMandatoryRelease, format: "numeric" },
            { text: activity.daysFishedOther, format: "numeric" },
            { text: activity.count, format: "numeric" },
            { html: renderLinks(activity.id), format: "numeric" }
        ]) }}
    {% endfor %}
{% endif %}

{% if catches.length %}
    {% for fish in catches %}
        {% if fmt %}
            {{ salmonAndLargeTroutItems.push([
                { text: fish.dateCaught },
                { text: fish.activity.river.name },
                { text: fish.species.name },
                { text: fish.weight },
                { text: fish.method.name },
                { text: "Yes" if fish.released else "No" },
                { html: renderLinks(fish.id), format: "numeric" },
                { html: renderCheck(fish.id, "exclude-catch", fish.reportingExclude), format: "numeric" }
            ]) }}
        {% else %}
            {{ salmonAndLargeTroutItems.push([
                { text: fish.dateCaught },
                { text: fish.activity.river.name },
                { text: fish.species.name },
                { text: fish.weight },
                { text: fish.method.name },
                { text: "Yes" if fish.released else "No" },
                { html: renderLinks(fish.id), format: "numeric" }
            ]) }}
        {% endif %}
    {% endfor %}
{% endif %}

{% if smallCatches.length %}
    {% for catch in smallCatches %}
        {% if fmt %}
            {{ smallCatchItems.push([
                { text: catch.month },
                { text: catch.river },
                { text: catch.fly or 0, format: "numeric" },
                { text: catch.spinner or 0, format: "numeric" },
                { text: catch.bait or 0, format: "numeric" },
                { text: catch.unknown or 0, format: "numeric" },
                { text: catch.released, format: "numeric" },
                { html: renderLinks(catch.id | replace("smallCatches", "small-catches")), format: "numeric" },
                { html: renderCheck(catch.id, "exclude-small-catch", catch.reportingExclude), format: "numeric" }
            ]) }}
        {% else %}
            {{ smallCatchItems.push([
                { text: catch.month },
                { text: catch.river },
                { text: catch.fly or 0, format: "numeric" },
                { text: catch.spinner or 0, format: "numeric" },
                { text: catch.bait or 0, format: "numeric" },
                { text: catch.released, format: "numeric" },
                { html: renderLinks(catch.id | replace("smallCatches", "small-catches")), format: "numeric" }
            ]) }}
        {% endif %}
    {% endfor %}
{% endif %}

{% if fmt %}
    {% set largeCatchHeader = [
        { text: "Date" },
        { text: "River" },
        { text: "Type" },
        { text: "Weight" },
        { text: "Method" },
        { text: "Released" },
        { text: "Actions", format: "numeric" },
        { text: "Ex.", format: "numeric" }
    ] %}
{% else %}
    {% set largeCatchHeader = [
        { text: "Date" },
        { text: "River" },
        { text: "Type" },
        { text: "Weight" },
        { text: "Method" },
        { text: "Released" },
        { text: "Actions", format: "numeric" }
    ] %}
{% endif %}

{% if fmt %}
    {% set smallCatchHeader = [
        { text: "Month" },
        { text: "River" },
        { text: "Fly", format: "numeric" },
        { text: "Spinner", format: "numeric" },
        { text: "Bait", format: "numeric" },
        { text: "Unknown", format: "numeric" },
        { text: "Released", format: "numeric" },
        { text: "Actions", format: "numeric" },
        { text: "Ex.", format: "numeric" }
    ] %}
{% else %}
    {% set smallCatchHeader = [
        { text: "Month" },
        { text: "River" },
        { text: "Fly", format: "numeric" },
        { text: "Spinner", format: "numeric" },
        { text: "Bait", format: "numeric" },
        { text: "Released", format: "numeric" },
        { text: "Actions", format: "numeric" }
    ] %}
{% endif %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <form method="post">
            <h1 class="govuk-heading-l">Your {{ year }} catch return</h1>

            {{ govukTable({
                caption: "Rivers fished",
                captionClasses: "govuk-heading-m",
                firstCellIsHeader: false,
                attributes: { id: "river" },
                head: [
                    { text: "River" },
                    { text: "Days fished (1 Jan-16 Jun)", format: "numeric" },
                    { text: "Days fished (17 Jun-31 Dec)", format: "numeric" },
                    { text: "Fish caught", format: "numeric" },
                    { text: "Actions", format: "numeric" }
                ],
                rows: riverRows
            }) }}

            <p class="govuk-body" style="text-align:right">
                {% if activities.length === 0 %}
                    <a id="activities-add" class="govuk-link " href="/activities/add">Add a river</a>
                {% else %}
                    <a id="activities-add" class="govuk-link " href="/activities/add">Add another river</a>
                {% endif %}
            </p>

            {% if activities.length %}
                {{ govukTable({
                    caption: "Small adult sea trout (1lb and under)",
                    captionClasses: "govuk-heading-m",
                    firstCellIsHeader: false,
                    attributes: { id: "small" },
                    head: smallCatchHeader,
                    rows: smallCatchItems
                }) }}

                <p class="govuk-body" style="text-align:right">
                    {% if smallCatches.length === 0 %}
                        <a id="small-catches-add" class="govuk-link " href="small-catches/add">Add a small adult sea trout catch</a>
                    {% else %}
                        <a id="small-catches-add" class="govuk-link " href="small-catches/add">Add another small adult sea trout catch</a>
                    {% endif %}
                </p>

                {{ govukTable({
                    caption: "Salmon and large adult sea trout",
                    captionClasses: "govuk-heading-m",
                    firstCellIsHeader: false,
                    attributes: { id: "large" },
                    head: largeCatchHeader,
                    rows: salmonAndLargeTroutItems
                }) }}

                <p class="govuk-body" style="text-align:right">
                    {% if catches.length === 0 %}
                        <a id="catches-add" class="govuk-link " href="catches/add">Add a salmon or large adult sea trout</a>
                    {% else %}
                        <a id="catches-add" class="govuk-link " href="catches/add">Add another salmon or large adult sea trout</a>
                    {% endif %}
                </p>
            {% endif %}

            {% if activities.length %}
                {% if fmt %}
                    {{ govukCheckboxes({
                          idPrefix: "exclude",
                          name: "exclude",
                          items: [{
                                value: "submission",
                                text: "Exclude this catch return from reports?",
                                checked: reportingExclude
                          }]
                        })
                    }}
                {% else %}
                    <p class="govuk-body-m govuk-!-margin-top-7">If you plan to fish again for salmon or sea trout this year, click 'Save as draft', otherwise click 'Review catch return'.</p>
                {% endif %}
            {% endif %}

            {{ govukButton({
                name: "continue",
                text: "Review catch return",
                disabled: activities.length === 0
            }) }}

            {{ extra() }}
        </form>
        {% if activities.length %}
            <div>
                <a id="save" class="govuk-link govuk-body-m" href="/save">Save as draft</a>
            </div>
        {% else %}
            <div>
                <a id="cancel" class="govuk-link govuk-body-m" href="/">Cancel</a>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}
