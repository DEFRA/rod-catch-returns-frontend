{% extends "layout.html" %}

{% from "button/macro.njk" import govukButton %}
{% from "table/macro.njk" import govukTable %}
{% from "fieldset/macro.njk" import govukFieldset %}
{% from "checkboxes/macro.njk" import govukCheckboxes %}
{% from "navigation.njk" import navigationHeaderBlock %}

{% block header %}
    {% if fmt %}
        {{ navigationHeaderBlock() }}
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}

{% block pageTitle %}Your {{ year }} catch return - GOV.UK{% endblock %}

{% set riverRows = [] %}
{% set salmonAndLargeTroutItems = [] %}
{% set smallCatchItems = [] %}

{% macro renderLinks(id, desc) %}
    {% set editurl = id %}
    {% set deleteurl = "/delete/" + id %}
<!--suppress ALL -->
<span><a id="edit-{{ id }}" class="govuk-link" href="{{ editurl }}">Change<label class="link-reader">&nbsp;{{ desc }}</label></a>&nbsp;&#x7c;&nbsp;<a id="delete-{{ id }}" class="govuk-link" href="{{ deleteurl }}">Delete<label class="link-reader">&nbsp;{{ desc }}</label></a></span>
{% endmacro %}

{% macro renderCheck(id, name, checked) %}
<div class="rcr-tab-checkboxes__item">
    <input class="rcr-tab-checkboxes__input" type="checkbox" id="exclude-{{ id }}" name="{{ name }}" value="{{ id }}" {% if checked %}checked="checked"{% endif %}>
    <label for="exclude-{{ id }}" class="rcr-tab-checkboxes__label"></label>
</div>
{% endmacro %}

{%
    set activityTableHeadings = {
        river: "River",
        daysFishedMandatory: "Days fished (1 Jan-16 Jun)",
        daysFishedOther: "Days fished (17 Jun-31 Dec)",
        actions: "Actions"
    }
%}

{% if activities.length %}
    {% for activity in activities %}
        {{ riverRows.push([
            { text: activity.river.name, attributes: { 'data-label': activityTableHeadings.river} },
            { text: activity.daysFishedWithMandatoryRelease, format: "numeric", attributes: { 'data-label': activityTableHeadings.daysFishedMandatory} },
            { text: activity.daysFishedOther, format: "numeric", attributes: { 'data-label': activityTableHeadings.daysFishedOther} },
            { html: renderLinks(activity.id, activity.river.name), format: "numeric", attributes: { 'data-label': activityTableHeadings.actions} }
        ]) }}
    {% endfor %}
{% endif %}

{% if fmt %}
    {% set largeCatchHeader = [
        { text: "Date" },
        { text: "River" },
        { text: "Type" },
        { text: "Weight" },
        { text: "Method" },
        { text: "Released" },
        { text: "Actions", format: "numeric" },
        { text: "Ex.", format: "numeric" }
    ] %}
{% else %}
    {% set largeCatchHeader = [
        { text: "Date" },
        { text: "River" },
        { text: "Type" },
        { text: "Weight" },
        { text: "Method" },
        { text: "Released" },
        { text: "Actions", format: "numeric" }
    ] %}
{% endif %}

{% if catches.length %}
    {% for fish in catches %}
        {% if fmt %}
            {{ salmonAndLargeTroutItems.push([
                { text: fish.dateCaught, attributes: { 'data-label': largeCatchHeader[0].text} },
                { text: fish.activity.river.name, attributes: { 'data-label': largeCatchHeader[1].text} },
                { text: fish.species.name, attributes: { 'data-label': largeCatchHeader[2].text} },
                { text: fish.weight, attributes: { 'data-label': largeCatchHeader[3].text} },
                { text: fish.method.name, attributes: { 'data-label': largeCatchHeader[4].text} },
                { text: "Yes" if fish.released else "No", attributes: { 'data-label': largeCatchHeader[5].text} },
                { html: renderLinks(fish.id, fish.dateCaught + ' ' + fish.activity.river.name), format: "numeric", attributes: { 'data-label': largeCatchHeader[6].text}  },
                { html: renderCheck(fish.id, "exclude-catch", fish.reportingExclude), format: "numeric", attributes: { 'data-label': largeCatchHeader[7].text}  }
            ]) }}
        {% else %}
            {{ salmonAndLargeTroutItems.push([
                { text: fish.dateCaught, attributes: { 'data-label': largeCatchHeader[0].text} },
                { text: fish.activity.river.name, attributes: { 'data-label': largeCatchHeader[1].text} },
                { text: fish.species.name, attributes: { 'data-label': largeCatchHeader[2].text} },
                { text: fish.weight, attributes: { 'data-label': largeCatchHeader[3].text} },
                { text: fish.method.name, attributes: { 'data-label': largeCatchHeader[4].text} },
                { text: "Yes" if fish.released else "No", attributes: { 'data-label': largeCatchHeader[5].text} },
                { html: renderLinks(fish.id, fish.dateCaught + ' ' + fish.activity.river.name), format: "numeric", attributes: { 'data-label': largeCatchHeader[6].text} }
            ]) }}
        {% endif %}
    {% endfor %}
{% endif %}

{% if fmt %}
    {% set smallCatchHeader = [
        { text: "Month" },
        { text: "River" },
        { text: "Fly", format: "numeric" },
        { text: "Spinner", format: "numeric" },
        { text: "Bait", format: "numeric" },
        { text: "Unknown", format: "numeric" },
        { text: "Released", format: "numeric" },
        { text: "Actions", format: "numeric" },
        { text: "Ex.", format: "numeric" }
    ] %}
{% else %}
    {% if foundInternal %}
        {% set smallCatchHeader = [
            { text: "Month" },
            { text: "River" },
            { text: "Fly", format: "numeric" },
            { text: "Spinner", format: "numeric" },
            { text: "Bait", format: "numeric" },
            { text: "Unknown", format: "numeric" },
            { text: "Released", format: "numeric" },
            { text: "Actions", format: "numeric" }
        ] %}
    {% else %}
        {% set smallCatchHeader = [
            { text: "Month" },
            { text: "River" },
            { text: "Fly", format: "numeric" },
            { text: "Spinner", format: "numeric" },
            { text: "Bait", format: "numeric" },
            { text: "Released", format: "numeric" },
            { text: "Actions", format: "numeric" }
        ] %}
    {% endif %}
{% endif %}

{% if smallCatches.length %}
    {% for catch in smallCatches %}
        {% if fmt %}
            {{ smallCatchItems.push([
                { text: catch.month, attributes: { 'data-label': smallCatchHeader[0].text} },
                { text: catch.river, attributes: { 'data-label': smallCatchHeader[1].text} },
                { text: catch.fly or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[2].text} },
                { text: catch.spinner or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[3].text} },
                { text: catch.bait or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[4].text} },
                { text: catch.unknown or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[5].text} },
                { text: catch.released, format: "numeric", attributes: { 'data-label': smallCatchHeader[6].text} },
                { html: renderLinks(catch.id | replace("smallCatches", "small-catches"), catch.month + ' ' + catch.river), format: "numeric", attributes: { 'data-label': smallCatchHeader[7].text} },
                { html: renderCheck(catch.id, "exclude-small-catch", catch.reportingExclude), format: "numeric", attributes: { 'data-label': smallCatchHeader[8].text} }
            ]) }}
        {% else %}
            {% if foundInternal %}
                {{ smallCatchItems.push([
                    { text: catch.month, attributes: { 'data-label': smallCatchHeader[0].text} },
                    { text: catch.river, attributes: { 'data-label': smallCatchHeader[1].text} },
                    { text: catch.fly or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[2].text} },
                    { text: catch.spinner or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[3].text} },
                    { text: catch.bait or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[4].text} },
                    { text: catch.unknown or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[5].text} },
                    { text: catch.released, format: "numeric", attributes: { 'data-label': smallCatchHeader[5].text} },
                    { html: renderLinks(catch.id | replace("smallCatches", "small-catches"), catch.month + ' ' + catch.river), format: "numeric", attributes: { 'data-label': smallCatchHeader[6].text} }
                ]) }}
            {% else %}
                {{ smallCatchItems.push([
                    { text: catch.month, attributes: { 'data-label': smallCatchHeader[0].text} },
                    { text: catch.river, attributes: { 'data-label': smallCatchHeader[1].text} },
                    { text: catch.fly or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[2].text} },
                    { text: catch.spinner or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[3].text} },
                    { text: catch.bait or 0, format: "numeric", attributes: { 'data-label': smallCatchHeader[4].text} },
                    { text: catch.released, format: "numeric", attributes: { 'data-label': smallCatchHeader[5].text} },
                    { html: renderLinks(catch.id | replace("smallCatches", "small-catches"), catch.month + ' ' + catch.river), format: "numeric", attributes: { 'data-label': smallCatchHeader[6].text} }
                ]) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endif %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <form method="post">
            <h1 class="govuk-heading-l">Your {{ year }} catch return</h1>


            <h2 class="govuk-heading-m govuk-!-margin-bottom-1">Rivers fished</h2>

            {{ govukTable({
                classes: "rcr-responsive-summary-table",
                captionClasses: "govuk-heading-m",
                firstCellIsHeader: false,
                attributes: { id: "river" },
                head: [
                    { text: activityTableHeadings.river },
                    { text: activityTableHeadings.daysFishedMandatory, format: "numeric" },
                    { text: activityTableHeadings.daysFishedOther, format: "numeric" },
                    { text: activityTableHeadings.actions, format: "numeric" }
                ],
                rows: riverRows
            }) }}

            <p class="govuk-body summary-link-right">
                {% if activities.length === 0 %}
                    <a id="activities-add" class="govuk-link " href="/activities/add">Add a river</a>
                {% else %}
                    <a id="activities-add" class="govuk-link " href="/activities/add">Add another river</a>
                {% endif %}
            </p>

            {% if activities.length %}
                <h2 class="govuk-heading-m govuk-!-margin-top-6 govuk-!-margin-bottom-1">Small adult sea trout (1lb and under)</h2>
                <span class="govuk-caption-m govuk-!-margin-bottom-5">Skip this section if you did not catch any small adult sea trout</span>

                {{ govukTable({
                    classes: "rcr-responsive-summary-table",
                    captionClasses: "govuk-heading-m",
                    firstCellIsHeader: false,
                    attributes: { id: "small" },
                    head: smallCatchHeader,
                    rows: smallCatchItems
                }) }}

                <p class="govuk-body summary-link-right">
                    {% if smallCatches.length === 0 %}
                        <a id="small-catches-add" class="govuk-link " href="small-catches/add">Add a small adult sea trout catch</a>
                    {% else %}
                        <a id="small-catches-add" class="govuk-link " href="small-catches/add">Add another small adult sea trout catch</a>
                    {% endif %}
                </p>

                <h2 class="govuk-heading-m govuk-!-margin-top-6 govuk-!-margin-bottom-1">Salmon and large adult sea trout</h2>
                <span class="govuk-caption-m govuk-!-margin-bottom-5">Skip this section if you did not catch any salmon or large adult sea trout</span>

                {{ govukTable({
                    classes: "rcr-responsive-summary-table",
                    captionClasses: "govuk-heading-m",
                    firstCellIsHeader: false,
                    attributes: { id: "large" },
                    head: largeCatchHeader,
                    rows: salmonAndLargeTroutItems
                }) }}

                <p class="govuk-body summary-link-right" style="text-align:right">
                    {% if catches.length === 0 %}
                        <a id="catches-add" class="govuk-link " href="catches/add">Add a salmon or large adult sea trout</a>
                    {% else %}
                        <a id="catches-add" class="govuk-link " href="catches/add">Add another salmon or large adult sea trout</a>
                    {% endif %}
                </p>
            {% endif %}

            {% if activities.length %}
                {% if fmt %}
                    {{ govukCheckboxes({
                          idPrefix: "exclude",
                          name: "exclude",
                          items: [{
                                value: "submission",
                                text: "Exclude this catch return from reports?",
                                checked: reportingExclude
                          }]
                        })
                    }}
                {% else %}
                    <p class="govuk-body-m govuk-!-margin-top-7">If you plan to fish again for salmon or sea trout this year, select 'Save and return later', otherwise select 'Review catch return'.</p>
                {% endif %}
            {% endif %}

            {{ govukButton({
                name: "continue",
                text: "Review catch return",
                classes: "govuk-button-adjacent",
                disabled: activities.length === 0
            }) }}

            {% if fmt and activities.length %}
                {{ govukButton({
                    name: "save",
                    text: "Save and return later",
                    classes: "govuk-button-secondary govuk-button-adjacent",
                    attributes: { onclick: "var e=this;setTimeout(function(){e.disabled=true;},0);return true;" }
                }) }}
            {% endif %}

            {{ extra() }}
        </form>

        {% if activities.length %}
            {% if not fmt %}
                <div>
                    <a id="save" class="govuk-link govuk-body-m" href="/save">Save and return later</a>
                </div>
            {% endif %}
        {% else %}
            <div>
                <a id="cancel" class="govuk-link govuk-body-m" href="/did-you-fish">Cancel</a>
            </div>
        {% endif %}

    </div>
</div>

{% endblock %}
